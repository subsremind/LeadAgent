# LeadAgent 定时任务服务

## 问题概述

目前，项目的定时任务只有在API模块被编译时才能执行到。为了让定时任务能够在项目启动时就运行，我们需要一个独立的方式来启动任务服务。

## 解决方案

我们创建了一个独立的定时任务服务，可以通过专门的脚本来启动，无需依赖API模块的编译和运行。

## 实现细节

1. **独立的任务启动脚本** - 创建了 `scripts/start-tasks.ts` 文件，专门用于初始化和运行定时任务
2. **环境变量支持** - 脚本会自动加载项目的环境变量
3. **进程管理** - 添加了信号处理，确保服务可以优雅地关闭
4. **开发和生产两种模式** - 提供了针对不同环境的启动命令

## 使用方法

### 从项目根目录启动

#### 开发环境

```bash
pnpm tasks
```

#### 生产环境

```bash
pnpm tasks:prod
```

### 从API包目录启动

首先切换到API包目录：

```bash
cd packages/api
```

然后执行以下命令：

#### 开发环境

```bash
pnpm tasks
```

#### 生产环境

```bash
pnpm tasks:prod
```

## 定时任务的配置

定时任务的定义位于 `src/tasks/index.ts` 文件中，目前包含了获取Reddit帖子的定时任务。你可以在该文件中添加或修改任务。

任务的执行频率通过 `config.syncPost.cronExpression` 配置，默认值为 `"1/20 * * * * *"`（每20秒执行一次）。

## 注意事项

1. 确保在启动任务服务前，所有环境变量都已正确配置
2. 生产环境需要先构建项目（`pnpm build`），然后再启动任务服务
3. 任务服务会保持进程运行，需要手动停止（使用 Ctrl+C 或发送 SIGTERM 信号）
4. 日志信息会输出到控制台，可以根据需要配置日志持久化